# [Sukuwatto](https://sukuwatto.com) &middot; Backend

## Applications

| Name                  | Description                                                                                 |
| --------------------- | ------------------------------------------------------------------------------------------- |
| [Social](social/)     | Handles social resources like posts, comments, messages, actions and reports                |
| [Sqtrex](sqtrex/)     | Main application entrypoint, defines routings, tasks, authentication, etc.                  |
| [Users](users/)       | Handles user-related resources and actions (registrations, followers, feed streams, blocks) |
| [Workouts](workouts/) | Manages resources related to workouts, plans, exercises, user bio data, etc.                |

## REST API

| Endpoint                                       | Methods                | Description                                                                                                       | Model                                                                                                                                                           | Params                                                          |
| ---------------------------------------------- | ---------------------- | ----------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------- |
| /api/sign-up                                   | POST                   | User registration                                                                                                 | [CustomUser](users/models.py)                                                                                                                                   |                                                                 |
| /api/users/                                    | GET, PUT, DELETE       | Users' resources                                                                                                  | [CustomUser](users/models.py)                                                                                                                                   | username, email                                                 |
| /api/exercises/                                | GET, POST, PUT, DELETE | Exercises' resources                                                                                              | [Exercise](workouts/models.py)                                                                                                                                  | exercise_type, name                                             |
| /api/plans/                                    | GET, POST, PUT, DELETE | Plans' resources                                                                                                  | [Plan](workouts/models.py)                                                                                                                                      | public, user\_\_username                                        |
| /api/workouts/                                 | GET, POST, PUT, DELETE | Workouts' resources                                                                                               | [Workout](workouts/models.py)                                                                                                                                   | name, plan\_\_name, plan\_\_short_name, user\_\_username, start |
| /api/user-bio-data/                            | GET, POST, PUT, DELETE | Users' bio data resources                                                                                         | [UserBioData](workouts/models.py)                                                                                                                               | user\_\_\username                                               |
| /api/posts/                                    | GET, POST, PUT, DELETE | Posts' resources                                                                                                  | [Post](social/models.py)                                                                                                                                        | user\_\_\username                                               |
| /api/comments/                                 | GET, POST, PUT, DELETE | Comments' resources                                                                                               | [Comment](social/models.py)                                                                                                                                     |                                                                 |
| /api/reports/                                  | GET, POST, PUT, DELETE | Reports' resources                                                                                                | [Report](social/models.py)                                                                                                                                      | state                                                           |
| /api/token                                     | POST                   | Takes a set of credentials and returns an auth JWT                                                                | [RefreshToken](https://github.com/jazzband/djangorestframework-simplejwt/blob/70b8f842fae867e9aaf89d6d8ef0044e5c2517ae/rest_framework_simplejwt/tokens.py#L293) |                                                                 |
| /api/refresh                                   | POST                   | Takes a refresh type JSON web token and returns an access type JWT                                                | [RefreshToken](https://github.com/jazzband/djangorestframework-simplejwt/blob/70b8f842fae867e9aaf89d6d8ef0044e5c2517ae/rest_framework_simplejwt/tokens.py#L293) |                                                                 |
| /api/logout                                    | POST                   | Logs the user out                                                                                                 |                                                                                                                                                                 |                                                                 |
| /api/adopt-plan/int:pk/                        | POST                   | Adopts a plan                                                                                                     |                                                                                                                                                                 |                                                                 |
| /api/plan-adopted/                             | GET                    | Checks if plan has been adopted                                                                                   |                                                                                                                                                                 | user_id, plan_id                                                |
| /api/leave-plan/int:pk/                        | POST                   | Abandons plan                                                                                                     |                                                                                                                                                                 |                                                                 |
| /api/adopted-plans/                            | GET                    | Returns plans that are owned by the searched user                                                                 |                                                                                                                                                                 | short_name, name, description, username                         |
| /api/owned-plans-paginated/                    | GET                    | Returns plans that are owned by the searched user, paginated                                                      |                                                                                                                                                                 | short_name, name, description, username                         |
| /api/adopted-plans-paginated/                  | GET                    | Returns plans that are adopted by the searched user, paginated                                                    |                                                                                                                                                                 | short_name, name, description, username                         |
| /api/plans-paginated/                          | GET                    | Returns plans, paginated                                                                                          |                                                                                                                                                                 | short_name, name, description, public, user\_\_username         |
| /api/muscles/                                  | GET                    | Returns all muscles                                                                                               |                                                                                                                                                                 |                                                                 |
| /api/metabolic-equivalent-tasks/               | GET                    | Returns all M.E.T.s                                                                                               |                                                                                                                                                                 |                                                                 |
| /api/mets/                                     | GET                    | Returns M.E.T.s for exercise                                                                                      |                                                                                                                                                                 | exercise                                                        |
| /api/user-available-chart-data/                | GET                    | Returns what sort of exercise types and bio record data a user has                                                |                                                                                                                                                                 | username                                                        |
| /api/workout-last/                             | GET                    | Gets the last work done by the authenticated user                                                                 |                                                                                                                                                                 | plan, plan_session, date_lte                                    |
| /api/workouts-overview-list/                   | GET                    | Returns workouts and their associated child records made by the authenticated user                                |                                                                                                                                                                 | user\_\_username, start, name, plan\_\_name, plan\_\_short_name |
| /api/workouts-by-date/                         | GET                    | Returns workouts (not returning any existing associated position records) by date                                 |                                                                                                                                                                 | username, date_lte, date_gte                                    |
| /api/workout-group-last/                       | GET                    | Returns last workout group for the authenticated user                                                             |                                                                                                                                                                 | plan_session_group, date_lte                                    |
| /api/workout-last-position/                    | GET                    | Get last workout position                                                                                         |                                                                                                                                                                 | username                                                        |
| /api/workout-visible/                          | GET                    | Returns whether the workout with the specified id is visible to the current user                                  |                                                                                                                                                                 | workout_id                                                      |
| /api/workout-editable/                         | GET                    | Returns whether the workout with the specified id is editable by the current user                                 |                                                                                                                                                                 | workout_id                                                      |
| /api/chart-distance-month/                     | GET                    | Returns data for the monthly distance chart of the specified user                                                 |                                                                                                                                                                 | username, date_lte, date_gte                                    |
| /api/chart-strength-progress/                  | GET                    | Returns strength workouts data with max weight lifted per exercise / date                                         |                                                                                                                                                                 | username, date_lte, date_gte, mechanics                         |
| /api/chart-weight/                             | GET                    | Returns all weight records for the user and dates specified                                                       |                                                                                                                                                                 | user\_\_username, date                                          |
| /api/user-bio-datas-by-date/                   | GET                    | Return user bio data                                                                                              |                                                                                                                                                                 | user\_\_username, date_lte, date_gte                            |
| /api/user-bio-data-last/                       | GET                    | Returns last user bio data                                                                                        |                                                                                                                                                                 | username, date_lte                                              |
| /api/user-body-composition-last/               | GET                    | Returns last user bio data that has body fat / muscle mass / water weight percentages                             |                                                                                                                                                                 | username, date_lte                                              |
| /api/file-upload/                              | POST                   | Uploads a file                                                                                                    |                                                                                                                                                                 |                                                                 |
| /api/content-types/                            | GET                    | Returns all content types                                                                                         |                                                                                                                                                                 |                                                                 |
| /api/get-user/                                 | GET                    | Returns the user data for the specified username                                                                  |                                                                                                                                                                 | username                                                        |
| /api/user-profile-filename/                    | GET                    | Returns the filename for the user profile picture                                                                 |                                                                                                                                                                 | username                                                        |
| /api/user-email/                               | GET                    | Returns the current user's e-mail                                                                                 |                                                                                                                                                                 |                                                                 |
| /api/user-validate-password/                   | POST                   | Validates the password, checking its size, characters and similarity to other user information                    |                                                                                                                                                                 | user model                                                      |
| /api/user-change-password/                     | POST                   | Changes the current logged-in user's password                                                                     |                                                                                                                                                                 | old_password, new_password                                      |
| /api/user-stream/                              | GET                    | Gets the current logged-in user's feed                                                                            |                                                                                                                                                                 |                                                                 |
| /api/users-search/                             | GET                    | Gets all users, paginated                                                                                         |                                                                                                                                                                 | username                                                        |
| /api/user-liked/                               | GET                    | Returns whether the authenticated user liked the object with the specified content type                           |                                                                                                                                                                 | content_type_id, object_id                                      |
| /api/user-exists/                              | GET                    | Returns whether the user with the specified username exists                                                       |                                                                                                                                                                 | username                                                        |
| /api/actor-stream/                             | GET                    | Returns a user's feed of activities filtered by what the current user can see, paginated                          |                                                                                                                                                                 | username                                                        |
| /api/target-stream/                            | GET                    | Returns an object's (post, activity, plan, etc.) feed of activity, optionally filtered by verb                    |                                                                                                                                                                 | content_type_id, object_id, verb                                |
| /api/action-object-stream/                     | GET                    | Returns an action object's (post, activity, plan, etc.) feed of likes/comments                                    |                                                                                                                                                                 | content_type_id, object_id                                      |
| /api/followers/                                | GET                    | Returns the list of followers of a user, paginated                                                                |                                                                                                                                                                 | username                                                        |
| /api/following/                                | GET                    | Returns the list of users a user is following, paginated                                                          |                                                                                                                                                                 | username                                                        |
| /api/is-blocked/                               | GET                    | Indicates whether the user with the specified username is blocked by the authenticated user                       |                                                                                                                                                                 | username                                                        |
| /api/block/                                    | POST                   | Blocks the user with the specified id                                                                             |                                                                                                                                                                 | user_id                                                         |
| /api/unblock/                                  | POST                   | Unblocks the user with the specified user id                                                                      |                                                                                                                                                                 | user_id                                                         |
| /api/blocked-users/                            | GET                    | Gets the current user's list of blocked users, paginated                                                          |                                                                                                                                                                 |                                                                 |
| /api/user-skills/                              | GET                    | Returns a list of skills for a user                                                                               |                                                                                                                                                                 | username                                                        |
| /api/follow-requests/                          | GET                    | Returns a list of follow requests for the current logged-in user, paginated                                       |                                                                                                                                                                 |                                                                 |
| /api/follow-request-number/                    | GET                    | Returns the total number of following users and follow requests for the current logged-in user                    |                                                                                                                                                                 |                                                                 |
| /api/is-following/                             | GET                    | Returns if the authenticated user is following or has requested a follow from the supplied user_id                |                                                                                                                                                                 | username                                                        |
| /api/follow/                                   | POST                   | Follows a user                                                                                                    |                                                                                                                                                                 | user_id                                                         |
| /api/unfollow/                                 | POST                   | Unfollows a user                                                                                                  |                                                                                                                                                                 | user_id                                                         |
| /api/approve-follow-request/                   | POST                   | Approves the follow request that the user with the specified id made to the current user                          |                                                                                                                                                                 | user_id                                                         |
| /api/reject-follow-request/                    | POST                   | Rejects the follow request that the user with the specified id made to the current user                           |                                                                                                                                                                 | user_id                                                         |
| /api/toggle-like/                              | POST                   | Toggles like on an object                                                                                         |                                                                                                                                                                 | content_type_id, object_id                                      |
| /api/messages/                                 | GET                    | Returns a list of messages the current logged-in user and another user                                            |                                                                                                                                                                 | with_user                                                       |
| /api/last-messages/                            | GET                    | Returns a list of conversations (last message for every contacted user) that the current logged-in user is having |                                                                                                                                                                 |                                                                 |
| /api/update-last-message/                      | POST                   | Marks all messages of a conversation as read between the current logged-in user and another user                  |                                                                                                                                                                 | correspondent                                                   |
| /api/unread-conversations/                     | GET                    | Gets a total for the conversations of the current logged-in user that have unread messages                        |                                                                                                                                                                 |                                                                 |
| /api/last-unread-conversation/                 | GET                    | Gets the date for the last unread conversation for the current logged-in user                                     |                                                                                                                                                                 |                                                                 |
| /api/weekly-leaderboard/                       | GET                    | Gets the weekly leaderboard                                                                                       |                                                                                                                                                                 | user\_\_username                                                |
| /api/monthly-leaderboard/                      | GET                    | Gets the monthly leaderboard                                                                                      |                                                                                                                                                                 | user\_\_username                                                |
| /api/yearly-leaderboard/                       | GET                    | Gets the yearly leaderboard                                                                                       |                                                                                                                                                                 | user\_\_username                                                |
| /api/alltime-leaderboard/                      | GET                    | Gets the all-time leaderboard                                                                                     |                                                                                                                                                                 | user\_\_username                                                |
| /api/weekly-leaderboard-dashboard/             | GET                    | Gets the weekly leaderboard user in the current logged-in user's dashboard                                        |                                                                                                                                                                 |                                                                 |
| /api/monthly-leaderboard-dashboard/            | GET                    | Gets the monthly leaderboard user in the current logged-in user's dashboard                                       |                                                                                                                                                                 |                                                                 |
| /api/yearly-leaderboard-dashboard/             | GET                    | Gets the yearly leaderboard user in the current logged-in user's dashboard                                        |                                                                                                                                                                 |                                                                 |
| /api/alltime-leaderboard-dashboard/            | GET                    | Gets the all-time leaderboard user in the current logged-in user's dashboard                                      |                                                                                                                                                                 |                                                                 |
| /api/exercise-in-use/                          | GET                    | Returns a boolean indicating if the exercise is in use anywhere                                                   |                                                                                                                                                                 | exercise                                                        |
| /api/exercise-in-use-on-other-users-resources/ | GET                    | Returns a boolean indicating if the exercise is in use in other users' resources                                  |                                                                                                                                                                 | exercise                                                        |
| /api/top-exercises/                            | GET                    | Gets the exercises with most associated workouts for the current user and exercise type                           |                                                                                                                                                                 | exercise_type                                                   |
| /api/request-personal-data/                    | POST                   | Requests all personal data collected by the authenticated user on the website, to be sent via e-mail              |                                                                                                                                                                 |                                                                 |
| /api/password-reset-validate-token/            | POST                   | Verifies if the rest password token is valid                                                                      |                                                                                                                                                                 | token                                                           |
| /api/password-reset-confirm/                   | POST                   | Confirms password reset                                                                                           |                                                                                                                                                                 | token, password                                                 |
| /api/password-reset/                           | POST                   | Requests a password reset link                                                                                    |                                                                                                                                                                 | email                                                           |
| /api/ban-user/                                 | POST                   | Bans a user                                                                                                       |                                                                                                                                                                 | username                                                        |
| /api/reinstate-user/                           | POST                   | Reinstates a user                                                                                                 |                                                                                                                                                                 | username                                                        |

### Notes

- Only authenticated users can create or alter resources (with the exception of their own user creation during sign up);
- Most resources are protected by a [visibility mixin](sqtrex/visibility.py), allowing for the creator to decide who can view each resource (everyone / every registered user / followers / only the creator);

## WebSockets API

| Endpoint                                                     | Description                                                                  | Models                                                       |
| ------------------------------------------------------------ | ---------------------------------------------------------------------------- | ------------------------------------------------------------ |
| [ws/chat/\<:user\>/\<:correspondent\>/](social/consumers.py) | Chat conversation between user and a correspondent                           | [Message](social/models.py), [LastMessage](social/models.py) |
| [ws/feed/\<:user\>/](social/consumers.py)                    | Feed of latest conversations, used to alert the UI when there's new messages | [Message](social/models.py)                                  |

### Chat consumer

#### Receives

| Parameter   | Description             | Values                                       | Applicable to                                |
| ----------- | ----------------------- | -------------------------------------------- | -------------------------------------------- |
| type        | Type of action          | chat_message / edit_message / delete_message |                                              |
| uuid        | Message identifier      |                                              | chat_message / edit_message / delete_message |
| message     | Message content         |                                              | chat_message / edit_message                  |
| date        | Date of the message     |                                              | chat_message / edit_message                  |
| edited_date | Date message was edited |                                              | edit_message                                 |

**Example:**

> `{"type":"chat_message","date":"2022-07-29T09:46:36.284Z","uuid":"2d57ff9a-8763-45b9-9783-2c564512357f","message":"how have you been?"}`

#### Sends

| Parameter   | Description                              | Values                                       | In response to                               |
| ----------- | ---------------------------------------- | -------------------------------------------- | -------------------------------------------- |
| type        | Type of action                           | chat_message / edit_message / delete_message | chat_message / edit_message / delete_message |
| uuid        | Message identifier                       |                                              | chat_message / edit_message / delete_message |
| message     | Message content                          |                                              | chat_message / edit_message                  |
| date        | Date of the message                      |                                              | chat_message / edit_message                  |
| edited_date | Date message was edited                  |                                              | edit_message                                 |
| from_user   | User id that the message originates from |                                              | chat_message / edit_message                  |

**Example:**

> `{"type":"chat_message","date":"2022-07-29T09:46:36.284Z","uuid":"2d57ff9a-8763-45b9-9783-2c564512357f","message":"how have you been?","from_user":1}`

### Feed consumer

#### Receives

| Parameter   | Description                              | Values                                       | In response to                               |
| ----------- | ---------------------------------------- | -------------------------------------------- | -------------------------------------------- |
| type        | Type of action                           | chat_message / edit_message / delete_message | chat_message / edit_message / delete_message |
| uuid        | Message identifier                       |                                              | chat_message / edit_message / delete_message |
| message     | Message content                          |                                              | chat_message / edit_message                  |
| date        | Date of the message                      |                                              | chat_message / edit_message                  |
| edited_date | Date message was edited                  |                                              | edit_message                                 |
| from_user   | User id that the message originates from |                                              | chat_message / edit_message                  |

**Example:**

> `{"type":"chat_message","date":"2022-07-29T09:46:36.284Z","uuid":"2d57ff9a-8763-45b9-9783-2c564512357f","message":"how have you been?","from_user":1}`

#### Sends

| Parameter   | Description                              | Values                                       | In response to                               |
| ----------- | ---------------------------------------- | -------------------------------------------- | -------------------------------------------- |
| type        | Type of action                           | chat_message / edit_message / delete_message | chat_message / edit_message / delete_message |
| uuid        | Message identifier                       |                                              | chat_message / edit_message / delete_message |
| message     | Message content                          |                                              | chat_message / edit_message                  |
| date        | Date of the message                      |                                              | chat_message / edit_message                  |
| edited_date | Date message was edited                  |                                              | edit_message                                 |
| from_user   | User id that the message originates from |                                              | chat_message / edit_message                  |

**Example:**

> `{"type":"chat_message","date":"2022-07-29T09:46:36.284Z","uuid":"2d57ff9a-8763-45b9-9783-2c564512357f","message":"how have you been?","from_user":1}`

## Worker tasks

| Name                                                    | Description                                                                                         |
| ------------------------------------------------------- | --------------------------------------------------------------------------------------------------- |
| [users.tasks.email_reset_password_link](users/tasks.py) | Sends an e-mail with a reset password link to a user's address                                      |
| [users.tasks.delete_image_file](users/tasks.py)         | Deletes no longer used images                                                                       |
| [sqtrex.tasks.email_user_data](sqtrex/tasks.py)         | Collects all user data, zips it and sends it to the user e-mail (used to comply with GDPR policies) |
| [workouts.tasks.every_year](workouts/tasks.py)          | Resets leaderboard positions after every year                                                       |
| [workouts.tasks.every_month](workouts/tasks.py)         | Resets leaderboard positions after every month                                                      |
| [workouts.tasks.every_week](workouts/tasks.py)          | Resets leaderboard positions after every week                                                       |
