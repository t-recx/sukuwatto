<div class="loading-spinner-container" *ngIf="loading">
    <app-loading-spinner></app-loading-spinner>
</div>

<div *ngIf="plan && !loading">
    <div *ngIf="!userIsOwner">
      <app-plan-card [plan]=plan 
        [showSaveDeleteButtons]=false >
      </app-plan-card>
    </div>
    <div *ngIf="userIsOwner">
    <form class="siimple-card siimple-form" #planForm="ngForm" >
        <div class="siimple-form-title form-title">Plan detail</div>
        <div class="siimple-grid">
            <div class="siimple-grid-row">
                <div class="siimple-grid-col siimple-grid-col--3 siimple-grid-col-sm--5 siimple--py-0">
                    <div class="siimple-form-field">
                        <div class="siimple-form-field-label">Short name</div>
                        <input type="text" class="siimple-input siimple-input--fluid"  required
                            applyFocus
                            name="short_name" id="short_name" [(ngModel)]="plan.short_name" #short_name="ngModel">

                        <div *ngIf="short_name.invalid && (short_name.dirty || triedToSave)">
                            <div class="siimple-field-helper siimple--color-error">This field can't be empty</div>
                        </div>
                    </div>
                </div>
                <div class="siimple-grid-col siimple-grid-col--9 siimple-grid-col-sm--7 siimple--py-0">
                    <div class="siimple-form-field">
                        <div class="siimple-form-field-label">Name</div>
                        <input type="text" class="siimple-input siimple-input--fluid" required name="name" id="name"
                            [(ngModel)]="plan.name" #name="ngModel">

                        <div *ngIf="name.invalid && (name.dirty || triedToSave)">
                            <div class="siimple-field-helper siimple--color-error">This field can't be empty</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="siimple-grid-row">
                <div class="siimple-grid-col siimple-grid-col--12 siimple--py-0">
                    <div class="siimple-form-field">
                        <label class="siimple-label">Public</label>
                        <div class="siimple-switch">
                            <input type="checkbox" name="public" id="public" [(ngModel)]="plan.public" #public="ngModel">
                            <label for="public"></label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="siimple-grid-row">
                <div class="siimple-grid-col siimple-grid-col--12 siimple--py-0">
                    <div class="siimple-form-field">
                        <div class="siimple-form-field-label">Website</div>
                        <input type="text" class="siimple-input siimple-input--fluid"  
                            name="website" id="website" [(ngModel)]="plan.website" #website="ngModel">

                    </div>
                </div>
            </div>
            <div class="siimple-grid-row">
                <div class="siimple-grid-col siimple-grid-col--12 siimple--py-0">
                    <div class="siimple-form-field">
                        <div class="siimple-form-field-label">Description</div>
                        <textarea type="text" class="siimple-textarea siimple-textarea--fluid" rows="3" required
                            name="description" id="description" [(ngModel)]="plan.description" #description="ngModel">
                        </textarea>

                        <div *ngIf="description.invalid && (description.dirty || triedToSave)">
                            <div class="siimple-field-helper siimple--color-error">This field can't be empty</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="sessions">
            <div class="siimple-tabs">
                <div class="siimple-tabs-item" *ngFor="let session of plan.sessions"
                    [class.siimple-tabs-item--selected]="session==selectedSession" (click)="selectSession(session)">
                    {{session.name}}
                    <fa-icon [icon]="faTimesCircle" class="siimple--ml-1" (click)="removeSession(session)"></fa-icon>
                </div>
                <div class="siimple-tabs-item" (click)="addSession()">
                    <fa-icon [icon]="faCalendarPlus" class=""></fa-icon>
                    <span class="siimple--ml-1" 
                        [class.siimple--display-sm-none]="plan.sessions && plan.sessions.length > 0">
                        Add Session
                    </span>
                </div>
            </div>
            <div>
                <div class="tab-content" *ngFor="let session of plan.sessions"
                    [class.tab-content-selected]="session==selectedSession">
                    <app-plan-session [planSession]=session [triedToSave]=triedToSave>
                    </app-plan-session>
                </div>
            </div>
        </div>
        <app-plan-progression-strategies type_label="Plan" [progressions]=plan.progressions [triedToSave]=triedToSave>
        </app-plan-progression-strategies> 

        <button type="button" class="siimple-btn siimple-btn--success siimple--mt-2" (click)="save()">
            <fa-icon [icon]="faSave" class="  siimple--mr-1" *ngIf="!saving"></fa-icon>
            <fa-icon [icon]="faCircleNotch"  [spin]=true class="  siimple--mr-1" *ngIf="saving"></fa-icon>
            Save
        </button>
        <button type="button" *ngIf="plan.id" class="siimple-btn siimple-btn--error siimple--mt-2 siimple--ml-2" (click)="toggleDeleteModal()">
            <fa-icon [icon]="faTrash" class="  siimple--mr-1" *ngIf="!deleting"></fa-icon>
            <fa-icon [icon]="faCircleNotch"  [spin]=true class="  siimple--mr-1" *ngIf="deleting"></fa-icon>
            Delete
        </button>
    </form>
    </div>
</div>

<app-delete-modal 
    [(visible)]="deleteModalVisible"
    title='Delete plan?'
    body='This will delete your plan and associated data. Are you sure you want to proceed?'
    (deleted)="delete()"
    (canceled)="toggleDeleteModal()"
    >
</app-delete-modal>