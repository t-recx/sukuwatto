<article class="siimple-card" *ngIf="plan">
    <header class="siimple-card-header">
        <a class="siimple-link" [routerLink]=routerLink>
            {{plan.name}}
        </a>

        <div *ngIf="showSaveDeleteButtons && !deleting && isLoggedIn()" class="siimple-modal-header-close" (click)="toggleDeleteModal()"></div>

        <fa-icon class="loading-delete-icon" [icon]="faCircleNotch" [spin]=true *ngIf="deleting"></fa-icon>
    </header>
    <div class="siimple-card-body">
        <p class="siimple-p keep-original-formatting">{{plan.description}}</p>

        <div class="siimple-rule siimple--mt-3"></div>

        <div class="session-list">
            <div class="siimple-card session-card" *ngFor="let session of plan.sessions">
                <div class="siimple-card-header">
                    {{session.name}}
                </div>
                <div class="siimple-card-body" *ngFor="let group_order of getGroupOrders(session)">
                    <span *ngFor="let group of getGroups(session, group_order); let i = index;">
                        <span *ngIf="i > 0 && i < getGroups(session, group_order).length">
                            <div class="siimple--text-bold" *ngIf="hasGroupsWithMoreThanOneExercise(session, group_order); else groupsWithJustOneExercise">
                                alternating with
                            </div>
                            <ng-template #groupsWithJustOneExercise>
                                /
                            </ng-template>
                        </span>
                        <div *ngFor="let exercise_order of getExerciseOrders(group)">
                            <span *ngFor="let workoutActivity of getExercises(group, exercise_order); let ai = index;">
                                <span *ngIf="ai > 0">
                                    /
                                </span>

                                <span *ngIf="workoutActivity.exercise">
                                    {{workoutActivity.exercise.short_name}}
                                </span>
                                <span *ngIf="workoutActivity.number_of_sets && workoutActivity.number_of_sets > 1">
                                    <span>
                                        x
                                    </span>
                                    <span>
                                        {{workoutActivity.number_of_sets}}
                                    </span>
                                </span>

                                <span *ngIf="workoutActivity.exercise.exercise_type == 'c'">
                                    <span *ngIf="showParameterBlock(session, workoutActivity, parameterType.Speed)">
                                        <span
                                            *ngIf="workoutActivity.speed || workoutActivity.speed_type == speedType.Parameter">
                                            at
                                        </span>

                                        <span *ngIf="workoutActivity.speed">
                                            <span *ngIf="workoutActivity.speed_type==speedType.Standard ||
                                            workoutActivity.speed_type==speedType.Range">
                                                <span *ngIf="workoutActivity.speed % 1 == 0">
                                                    {{workoutActivity.speed | number: '1.0-0'}}
                                                </span>
                                                <span *ngIf="workoutActivity.speed % 1 != 0">
                                                    {{workoutActivity.speed}}
                                                </span>
                                            </span>

                                            <span *ngIf="workoutActivity.speed_type==speedType.Range">
                                                <span>
                                                    -
                                                </span>
                                                <span *ngIf="workoutActivity.speed_up_to % 1 == 0">
                                                    {{workoutActivity.speed_up_to | number: '1.0-0'}}
                                                </span>
                                                <span *ngIf="workoutActivity.speed_up_to % 1 != 0">
                                                    {{workoutActivity.speed_up_to}}
                                                </span>
                                            </span>

                                            <span *ngIf="workoutActivity.speed_type==speedType.AFAP">
                                                AFAP
                                            </span>
                                        </span>

                                        <span *ngIf="workoutActivity.speed && workoutActivity.speed_unit">
                                            {{getUnitCode(workoutActivity.speed_unit)}}
                                        </span>

                                        <span *ngIf="showWorkingPercentage(session, workoutActivity.exercise, workoutActivity.working_speed_percentage)">
                                            {{workoutActivity.working_speed_percentage | number: '1.0-0'}}% working speed
                                        </span>
                                    </span>

                                    <span *ngIf="showParameterBlock(session, workoutActivity, parameterType.Distance)">
                                        <span>
                                            for
                                        </span>

                                        <span *ngIf="workoutActivity.distance">
                                            <span *ngIf="workoutActivity.distance_type==distanceType.Standard ||
                                            workoutActivity.distance_type==distanceType.Range">
                                                <span *ngIf="workoutActivity.distance % 1 == 0">
                                                    {{workoutActivity.distance | number: '1.0-0'}}
                                                </span>
                                                <span *ngIf="workoutActivity.distance % 1 != 0">
                                                    {{workoutActivity.distance}}
                                                </span>
                                            </span>
                                            <span *ngIf="workoutActivity.distance_type==distanceType.Range">
                                                <span>
                                                    -
                                                </span>
                                                <span *ngIf="workoutActivity.distance_up_to % 1 == 0">
                                                    {{workoutActivity.distance_up_to | number: '1.0-0'}}
                                                </span>
                                                <span *ngIf="workoutActivity.distance_up_to % 1 != 0">
                                                    {{workoutActivity.distance_up_to}}
                                                </span>
                                            </span>
                                        </span>

                                        <span *ngIf="workoutActivity.distance && workoutActivity.distance_unit">
                                            {{getUnitCode(workoutActivity.distance_unit)}}
                                        </span>

                                        <span *ngIf="showWorkingPercentage(session, workoutActivity.exercise, workoutActivity.working_distance_percentage)">
                                            {{workoutActivity.working_distance_percentage | number: '1.0-0'}}% working distance
                                        </span>
                                    </span>

                                    <span *ngIf="showParameterBlock(session, workoutActivity, parameterType.Time)">
                                        <span *ngIf="workoutActivity.distance ||
                                            (workoutActivity.distance_type && 
                                            workoutActivity.distance_type != distanceType.None); else alternativeTimeIntroduction">
                                            <span>
                                                in
                                            </span>
                                        </span>

                                        <ng-template #alternativeTimeIntroduction>
                                            for
                                        </ng-template>

                                        <span *ngIf="workoutActivity.time">
                                            <span *ngIf="workoutActivity.time_type==timeType.Standard ||
                                            workoutActivity.time_type==timeType.Range">
                                                <span *ngIf="workoutActivity.time % 1 == 0">
                                                    {{workoutActivity.time | number: '1.0-0'}}
                                                </span>
                                                <span *ngIf="workoutActivity.time % 1 != 0">
                                                    {{workoutActivity.time}}
                                                </span>
                                            </span>
                                            <span *ngIf="workoutActivity.time_type==timeType.Range">
                                                <span>
                                                    -
                                                </span>
                                                <span *ngIf="workoutActivity.time_up_to % 1 == 0">
                                                    {{workoutActivity.time_up_to | number: '1.0-0'}}
                                                </span>
                                                <span *ngIf="workoutActivity.time_up_to % 1 != 0">
                                                    {{workoutActivity.time_up_to}}
                                                </span>
                                            </span>
                                        </span>

                                        <span *ngIf="workoutActivity.time && workoutActivity.time_unit">
                                            {{getUnitCode(workoutActivity.time_unit)}}
                                        </span>

                                        <span *ngIf="showWorkingPercentage(session, workoutActivity.exercise, workoutActivity.working_time_percentage)">
                                            {{workoutActivity.working_time_percentage | number: '1.0-0'}}% working time
                                        </span>
                                    </span>

                                    <span *ngIf="workoutActivity.vo2max ||
                                        (workoutActivity.vo2max_type && 
                                        workoutActivity.vo2max_type != vo2MaxType.None)">
                                        <span>
                                            with
                                        </span>

                                        <span *ngIf="workoutActivity.vo2max">
                                            <span *ngIf="workoutActivity.vo2max_type==vo2MaxType.Standard ||
                                            workoutActivity.vo2max_type==vo2MaxType.Range">
                                                <span *ngIf="workoutActivity.vo2max % 1 == 0">
                                                    {{workoutActivity.vo2max | number: '1.0-0'}}%
                                                </span>
                                                <span *ngIf="workoutActivity.vo2max % 1 != 0">
                                                    {{workoutActivity.vo2max}}%
                                                </span>
                                            </span>
                                            <span *ngIf="workoutActivity.vo2max_type==vo2MaxType.Range">
                                                <span>
                                                    -
                                                </span>
                                                <span *ngIf="workoutActivity.vo2max_up_to % 1 == 0">
                                                    {{workoutActivity.vo2max_up_to | number: '1.0-0'}}%
                                                </span>
                                                <span *ngIf="workoutActivity.vo2max_up_to % 1 != 0">
                                                    {{workoutActivity.vo2max_up_to}}%
                                                </span>
                                            </span>
                                        </span>

                                        <span>
                                            VO2 max
                                        </span>
                                    </span>
                                </span>

                                <span *ngIf="workoutActivity.exercise.exercise_type == 's'">
                                    <span>
                                        x
                                    </span>
                                    <span *ngIf="workoutActivity.repetition_type==repetitionType.Standard">
                                        {{workoutActivity.number_of_repetitions}}
                                    </span>
                                    <span *ngIf="workoutActivity.repetition_type==repetitionType.Range">
                                        {{workoutActivity.number_of_repetitions}} -
                                        {{workoutActivity.number_of_repetitions_up_to}}
                                    </span>
                                    <span *ngIf="workoutActivity.repetition_type==repetitionType.ToFailure">
                                        F
                                    </span>
                                    <span *ngIf="workoutActivity.repetition_type==repetitionType.AMRAP">
                                        AMRAP
                                    </span>
                                    <span *ngIf="showWorkingPercentage(session, workoutActivity.exercise, workoutActivity.working_weight_percentage)">
                                        ({{workoutActivity.working_weight_percentage}}%)
                                    </span>
                                </span>
                            </span>
                        </div>
                    </span>
                </div>
            </div>
        </div>

        <div *ngIf="detailView">
            <div class="siimple-rule siimple--mt-3"></div>
        
            <div class="owner-user-container">
                <app-user-tag [username]=plan.user.username [profile_filename]=plan.user.profile_filename>
                </app-user-tag>
        
                <small class="siimple-small siimple--ml-2">{{plan.creation.toString() | timeAgo}}</small>
        
                <button *ngIf="showAdoptButton" class="siimple-btn adopt-plan-button siimple-btn--success" (click)="adopt()"
                    [disabled]="adopting">
                    <fa-icon [icon]="faChild" class="siimple--mr-1" *ngIf="!adopting"></fa-icon>
                    <fa-icon [icon]="faCircleNotch" class=" siimple--mr-1" [spin]=true *ngIf="adopting"></fa-icon>
                    Adopt
                </button>
            </div>
        </div>
    </div>
    <footer class="siimple-card-footer">
        <app-card-social-interaction 
            [target_plan]=plan.id
            [shareTitle]="shareTitle"
            [shareLink]="shareLink"
            [likeNumber]=plan.likes
            [commentNumber]=plan.comment_number
        content_type_model='plan' [id]=plan.id></app-card-social-interaction>
    </footer>
</article>

<app-delete-modal [(visible)]="deleteModalVisible" title='Delete plan?'
    body='This will delete your plan and associated data. Are you sure you want to proceed?' (deleted)="delete()"
    (canceled)="toggleDeleteModal()">
</app-delete-modal>